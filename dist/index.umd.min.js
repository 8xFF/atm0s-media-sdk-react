/*!
 * @8xff/atm0s-media-react v0.0.0
 * (c) Luong Ngoc Minh
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("@8xff/atm0s-media-js"),require("@8xff/atm0s-media-js/types/lib/utils/typed-event-emitter"),require("@8xff/atm0s-media-js/types/lib/utils/logger")):"function"==typeof define&&define.amd?define(["exports","react","@8xff/atm0s-media-js","@8xff/atm0s-media-js/types/lib/utils/typed-event-emitter","@8xff/atm0s-media-js/types/lib/utils/logger"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Atm0s={},e.React,e.Atm0s,e.typedEventEmitter,e.logger$1)}(this,(function(e,t,n,r,s){"use strict";var o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)};"function"==typeof SuppressedError&&SuppressedError;var a=s.getLogger("DeviceHook"),i=function(e){function t(t){var n=e.call(this)||this;return n.key=t,n.count=0,n.data={},a.log("Created container for local stream",t),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(t,e),t.prototype.setData=function(e){this.data=e,this.emit("changed",e)},t.prototype.retain=function(){return this.count+=1,a.log("Retain local stream",this.key,this.count),this.count},t.prototype.release=function(){var e;return this.count-=1,a.log("Release local stream",this.key,this.count),0==this.count&&(a.log("Destroy local stream",this.key),null===(e=this.data.media)||void 0===e||e.getTracks().map((function(e){e.stop()}))),this.count},t}(r.TypedEventEmitter),u=new Map;function c(e,t,n){var r=e+"-"+t,s=u.get(r);if(s)s.on("changed",n),n(s.data);else{s=new i(r),u.set(r,s);var o={};"audioinput"==e?o={audio:"string"!=typeof t||{deviceId:t}}:"videoinput"==e&&(o={video:"string"!=typeof t||{deviceId:t}}),navigator.mediaDevices.getUserMedia(o).then((function(e){e.cachedKey=r,null==s||s.setData({media:e}),n({media:e})})).catch((function(e){null==s||s.setData({error:e}),n({error:e})}))}return[s,r]}function l(e){var t=u.get(e);null==t||t.retain()}var d;e.SessionState=void 0,(d=e.SessionState||(e.SessionState={})).New="new",d.Connecting="connecting",d.Connected="connected",d.Reconnecting="reconnecting",d.Disconnected="disconnected",d.Error="error";var f=function(){function e(e){this.publisher=e}return Object.defineProperty(e.prototype,"state",{get:function(){return this.publisher.state},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"localStream",{get:function(){return this.publisher.localStream},enumerable:!1,configurable:!0}),e.prototype.on=function(e,t){this.publisher.on(e,t)},e.prototype.off=function(e,t){this.publisher.on(e,t)},e.prototype.switchStream=function(e){if(e){var t=e.cachedKey;t&&l(t)}if(this.publisher.localStream){var n=this.publisher.localStream.cachedKey;n&&(r=n,0==(null==(s=u.get(r))?void 0:s.release())&&u.delete(r))}var r,s;return this.publisher.switch(e)},e}(),m=t.createContext({}),v=0,S=function(){var n=t.useContext(m).data;return(null==n?void 0:n.state)||e.SessionState.New},p=0,y=function(r,s,o,a){var i=t.useMemo((function(){return p++}),[]),u=S(),c=t.useState(),l=c[0],d=c[1],f=t.useState(n.StreamReceiverState.NoSource),v=f[0],y=f[1],h=t.useState(),g=h[0],b=h[1],A=t.useContext(m),C=A.data,w=A.getConsumer,P=A.backConsumer,E=[e.SessionState.Connected,e.SessionState.Reconnecting].indexOf(u)>=0;t.useEffect((function(){if((null==C?void 0:C.session)&&r){var e=w(i,r);if(e)return e.on("state",y),y(e.state),d(e),function(){null==e||e.unview("use-consumer-"+i),null==e||e.off("state",y),P(i,r)}}}),[null==C?void 0:C.session,r]),t.useEffect((function(){if(g&&l&&E)return g.srcObject=l.view("use-consumer-"+i,s,o,a),function(){g.srcObject=null,l.unview("use-consumer-"+i)}}),[g,l,E]),t.useEffect((function(){g&&l&&E&&l.limit("use-consumer-"+i,s,o,a)}),[g,l,E,s,o,a]);return[function(e){b(e||void 0)},v,l]},h=function(e){var n=t.useState(),r=n[0],s=n[1];return t.useEffect((function(){if(r&&e)return r.srcObject=e,function(){r.srcObject=null}}),[r,e]),function(e){s(e||void 0)}},g=0,b=function(e){var n=y(e.remote,e.priority),r=n[0],s=n[1];return t.createElement("div",{className:"w-full h-full"},t.createElement("div",null,s),t.createElement("video",{muted:!0,autoPlay:!0,className:"w-full h-full",ref:r}))},A=function(e){var n=h(e.stream);return t.createElement("video",{muted:!0,autoPlay:!0,className:"w-full h-full",ref:n})};e.BlueseaSessionContext=m,e.LocalViewer=A,e.RemoteViewer=b,e.SessionProvider=function(r){var s=t.useState(0)[1],o=t.useMemo((function(){return{data:void 0}}),[]),a=t.useCallback((function(e){o.data=e,s(v++)}),[o,s]),i=t.useCallback((function(t,r){var s,i;if(null===(s=o.data)||void 0===s?void 0:s.session)return function(){var e;null===(e=o.data)||void 0===e||e.session.disconnect()};var u=n.createSession(t,r),c=new Map,d=new Map,f=new Map,m=new Map,v=new Map,S=new Map,p=new Map;null===(i=null==r?void 0:r.senders)||void 0===i||i.map((function(e){if(e.stream){var t=e.stream.cachedKey;t&&l(t)}})),u.on("connected",(function(){var t;(null===(t=o.data)||void 0===t?void 0:t.session)==u&&a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})})),u.on("mystream_added",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?c.set(s,t):d.set(s,t),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("mystream_updated",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?c.set(s,t):d.set(s,t),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("mystream_removed",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?c.delete(s):d.delete(s),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("stream_added",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?f.set(s,t):m.set(s,t),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("stream_updated",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?f.set(s,t):m.set(s,t),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("stream_removed",(function(t){var r;if((null===(r=o.data)||void 0===r?void 0:r.session)==u){var s=t.peerId+"-"+t.name;t.kind===n.StreamKinds.AUDIO?f.delete(s):m.delete(s),a({session:u,state:e.SessionState.Connected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})}})),u.on("disconnected",(function(){var t;(null===(t=o.data)||void 0===t?void 0:t.session)==u&&a({session:u,state:e.SessionState.Disconnected,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p})})),u.connect().catch((function(t){var n;(null===(n=o.data)||void 0===n?void 0:n.session)==u&&(console.error(t),a({session:u,state:e.SessionState.Error,myAudioStreams:Array.from(c.values()),myVideoStreams:Array.from(d.values()),audioStreams:Array.from(f.values()),videoStreams:Array.from(m.values()),publishers:v,consumers:S,consumerPairs:p}))})),a({session:u,state:e.SessionState.Connecting,myAudioStreams:[],myVideoStreams:[],audioStreams:[],videoStreams:[],publishers:v,consumers:S,consumerPairs:p})}),[o,a]),u=t.useCallback((function(){var e;(null===(e=o.data)||void 0===e?void 0:e.session)&&(o.data.session.disconnect(),a(void 0))}),[o,a]),c=t.useCallback((function(e,t){var n,r=o.data;if(null==r?void 0:r.session){var s=r.publishers.get(t.name);return s||(s={data:new f(r.session.createPublisher({stream:t.stream,name:t.name,kind:t.kind,preferredCodecs:t.preferredCodecs,simulcast:t.simulcast,maxBitrate:t.maxBitrate,contentHint:t.contentHint,screen:t.screen})),owners:new Map},r.publishers.set(t.name,s)),null===(n=r.publishers.get(t.name))||void 0===n||n.owners.set(e,(new Date).getTime()),s.data}}),[o]),d=t.useCallback((function(e,t){var n=o.data;if(null==n?void 0:n.session){var r=n.publishers.get(t.name);r&&(r.owners.delete(e),0==r.owners.size&&(r.data.switchStream(null),n.publishers.delete(t.name)))}}),[o]),S=t.useCallback((function(e,t){var n,r=o.data;if(null==r?void 0:r.session){var s=t.peerId+"-"+t.name,a=r.consumers.get(s);return a||(a={data:r.session.createConsumer(t),owners:new Map},r.consumers.set(s,a)),null===(n=r.consumers.get(s))||void 0===n||n.owners.set(e,(new Date).getTime()),a.data}}),[o]),p=t.useCallback((function(e,t){var n=o.data;if(null==n?void 0:n.session){var r=t.peerId+"-"+t.name,s=n.consumers.get(r);s&&(s.owners.delete(e),0==s.owners.size&&n.consumers.delete(r))}}),[o]),y=t.useCallback((function(e,t,n,r){var s,a=o.data;if(null==a?void 0:a.session){var i=t+"-"+n+"-"+r,u=a.consumerPairs.get(i);return u||(u={data:a.session.createConsumerPair(t,n,r),owners:new Map},a.consumerPairs.set(i,u)),null===(s=a.consumerPairs.get(i))||void 0===s||s.owners.set(e,(new Date).getTime()),u.data}}),[o]),h=t.useCallback((function(e,t,n,r){var s=o.data;if(null==s?void 0:s.session){var a=t+"-"+n+"-"+r,i=s.consumerPairs.get(a);i&&(i.owners.delete(e),0==i.owners.size&&s.consumerPairs.delete(a))}}),[o]);return t.useEffect((function(){if(r.url&&r.config)return i(r.url,r.config),function(){u()}}),[r.url,r.config,i,u]),t.createElement(m.Provider,{value:{data:o.data,connect:i,disconnect:u,getPublisher:c,backPublisher:d,getConsumer:S,backConsumer:p,getConsumerPair:y,backConsumerPair:h,update:a}},r.children)},e.StreamPublisherWrap=f,e.VideoViewer=function(e){return e.stream instanceof n.StreamRemote?t.createElement(b,{remote:e.stream,priority:e.priority}):t.createElement(A,{stream:e.stream})},e.getDevice=function(e,t){return new Promise((function(n,r){c(e,t,(function(e){e.error?r(e.error):n(e.media)}))}))},e.useActions=function(){var e=t.useContext(m);return{connect:e.connect,disconnect:e.disconnect,playAudioMix:function(){}}},e.useAudioLevelConsumer=function(e){var n=t.useState(void 0),r=n[0],s=n[1];return t.useEffect((function(){if(e){var t=function(e){s(e)};return e.on("audio_level",t),function(){e.off("audio_level",t)}}s(void 0)}),[e]),r},e.useAudioLevelMix=function(e,n){var r=t.useState(void 0),s=r[0],o=r[1],a=t.useContext(m).data;return t.useEffect((function(){var t=null==a?void 0:a.session.getMixMinusAudio();if(t){var r=function(e){o(e||void 0)};return t.on("source_".concat(e,":").concat(n),r),function(){null==t||t.off("source_".concat(e,":").concat(n),r)}}}),[e,n,null==a?void 0:a.session.getMixMinusAudio()]),s},e.useAudioLevelProducer=function(e){var n=t.useState(void 0),r=n[0],s=n[1];return t.useEffect((function(){if(e){var t=function(e){s(e)};return e.on("audio_level",t),function(){e.off("audio_level",t)}}s(void 0)}),[e]),r},e.useAudioSlotMix=function(e){var n=t.useState(void 0),r=n[0],s=n[1],o=t.useContext(m).data;return t.useEffect((function(){var t=null==o?void 0:o.session.getMixMinusAudio();if(t){var n=function(e){if(e){var t=e[0].split(":");s({peerId:t[0],streamName:t[1],audioLevel:e[1]})}else s(void 0)};return t.on("slot_".concat(e),n),function(){null==t||t.off("slot_".concat(e),n)}}}),[e,null==o?void 0:o.session.getMixMinusAudio()]),r},e.useConsumer=y,e.useConsumerPair=function(r,s,o,a,i,u){var c=t.useMemo((function(){return p++}),[]),l=S(),d=t.useState(),f=d[0],v=d[1],y=t.useState(n.StreamReceiverState.NoSource),h=y[0],g=y[1],b=t.useState(),A=b[0],C=b[1],w=t.useContext(m),P=w.data,E=w.getConsumerPair,k=w.backConsumerPair,x=[e.SessionState.Connected,e.SessionState.Reconnecting].indexOf(l)>=0;t.useEffect((function(){if(null==P?void 0:P.session){var e=E(c,r,s,o);if(e)return e.on("state",g),g(e.state),v(e),function(){null==e||e.off("state",g),k(c,r,s,o)}}}),[null==P?void 0:P.session,r,s,o]),t.useEffect((function(){if(A&&f&&x)return A.srcObject=f.view("use-consumer-"+c,a,i,u),function(){A.srcObject=null,f.unview("use-consumer-"+c)}}),[A,f,x]),t.useEffect((function(){A&&f&&x&&f.limit("use-consumer-"+c,a,i,u)}),[A,f,x,a,i,u]);return[function(e){C(e||void 0)},h,f]},e.useDevice=function(e,n){var r=t.useState({}),s=r[0],o=r[1];return t.useEffect((function(){if(0!=n){var t=c(e,n,o),r=t[0],s=t[1];return r.retain(),function(){o({media:void 0,error:void 0}),0==(null==r?void 0:r.release())&&u.delete(s)}}}),[e,n]),[s.media,s.error]},e.useDevices=function(e){var n=t.useState([]),r=n[0],s=n[1],o=t.useState(null),a=o[0],i=o[1];return t.useEffect((function(){navigator.mediaDevices.enumerateDevices().then((function(t){s(t.filter((function(t){return t.kind==e})))})).catch((function(e){s([]),i(e)}))}),[e]),[r,a]},e.useDisplayMedia=function(e,n){var r=t.useState({}),s=r[0],o=r[1];return t.useEffect((function(){var t;if(n)return navigator.mediaDevices.getDisplayMedia(e).then((function(e){t=e,o({media:e})})).catch((function(e){t=void 0,o({error:e})})),function(){o({media:void 0,error:void 0}),null==t||t.getTracks().forEach((function(e){e.stop()}))}}),[JSON.stringify(e),n]),[s.media,s.error]},e.useLocalConsumer=h,e.usePublisher=function(e){var r=t.useMemo((function(){return g++}),[]),s=t.useState(n.StreamSenderState.Created),o=s[0],a=s[1],i=t.useState(),u=i[0],c=i[1],l=t.useContext(m),d=l.data,f=l.getPublisher,v=l.backPublisher;return t.useEffect((function(){if(null==d?void 0:d.session){var t=f(r,e);if(t){var n=function(e){a(e)};return t.on("state",n),c(t),a(t.state),function(){null==t||t.off("state",n),v(r,e)}}}}),[null==d?void 0:d.session,e.kind+e.name]),[o,null==u?void 0:u.localStream,u]},e.useRemoteStreams=function(e,r){var s=t.useContext(m).data;return e==n.StreamKinds.AUDIO?!0===r?(null==s?void 0:s.myAudioStreams)||[]:(null==s?void 0:s.audioStreams)||[]:!0===r?(null==s?void 0:s.myVideoStreams)||[]:(null==s?void 0:s.videoStreams)||[]},e.useSession=function(){var e=t.useContext(m).data;return null==e?void 0:e.session},e.useSessionState=S,e.useUserMedia=function(e,n){var r=t.useState({}),s=r[0],o=r[1];return t.useEffect((function(){var t;if(n)return navigator.mediaDevices.getUserMedia(e).then((function(e){t=e,o({media:e})})).catch((function(e){t=void 0,o({error:e})})),function(){o({media:void 0,error:void 0}),null==t||t.getTracks().forEach((function(e){e.stop()}))}}),[JSON.stringify(e),n]),[s.media,s.error]}}));
//# sourceMappingURL=index.umd.min.js.map
